<canvas id="stars-canvas" class="stars-background"></canvas>

<div class="premium-reading-wrapper">
  <div class="premium-reading-card">

    <div class="premium-header">
      <div class="cosmic-decoration">‚ú® üåô ‚≠ê üåô ‚ú®</div>
      <h1 class="premium-title">Your Cosmic Reading</h1>
      <div class="premium-subtitle">
        A glimpse into your <%= @reading.category_tarot.capitalize %> journey
      </div>
      <div class="premium-date">
        <%= @reading.date.strftime("%B %d, %Y") %>
      </div>
    </div>

    <%# EXTRAER CARTAS %>
    <% tarot_cards = extract_tarot_cards(@reading.content) %>

    <%# FALLBACK SI NO HAY CARTAS %>
    <% if tarot_cards.empty? %>
      <% tarot_cards = [
        { filename: "00-TheFool", display_name: "The Fool" },
        { filename: "01-TheMagician", display_name: "The Magician" },
        { filename: "02-TheHighPriestess", display_name: "The High Priestess" },
        { filename: "Cups02", display_name: "Two of Cups" },
        { filename: "Swords13", display_name: "Queen of Swords" },
        { filename: "Wands08", display_name: "Eight of Wands" },
        { filename: "Pentacles10", display_name: "Ten of Pentacles" },
        { filename: "17-TheStar", display_name: "The Star" },
        { filename: "18-TheMoon", display_name: "The Moon" },
        { filename: "19-TheSun", display_name: "The Sun" }
      ] %>
    <% end %>

    <%# CARRUSEL %>
    <div class="tarot-carousel-container">
      <div class="tarot-carousel">

        <button class="carousel-nav prev" aria-label="Previous card">
          <span>‚ùÆ</span>
        </button>

        <div class="carousel-track-container">
          <div class="carousel-track">
            <% tarot_cards.first(10).each_with_index do |card, index| %>
              <div class="carousel-card <%= 'active' if index == 0 %>" data-card="<%= index %>">
                <div class="card-inner">
                  <%= image_tag "/cards/#{card[:filename]}.jpg",
                                alt: card[:display_name],
                                class: "tarot-card-image",
                                onerror: "this.src='/cards/00-TheFool.jpg'" %>
                </div>
                <div class="card-label">
                  <%= card[:display_name] %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <button class="carousel-nav next" aria-label="Next card">
          <span>‚ùØ</span>
        </button>

        <%# INDICADORES DENTRO DEL CARRUSEL %>
        <div class="carousel-indicators">
          <% tarot_cards.first(10).each_with_index do |card, i| %>
            <button class="indicator <%= 'active' if i == 0 %>" data-slide="<%= i %>"></button>
          <% end %>
        </div>

      </div>
    </div>

    <%# CONTENIDO %>
    <div class="premium-content-glass">
      <div class="premium-greeting">
        Dear <span class="highlight-name"><%= current_user.first_name || 'Seeker' %></span>,
      </div>

      <div class="premium-reading-text">
        <%= format_tarot_reading(@reading.content) %>
      </div>

      <div class="premium-signature">
        <div class="signature-line"></div>
        <div class="signature-text">May the stars guide your path</div>
        <div class="signature-line"></div>
      </div>
    </div>

    <%# BOTONES %>
    <div class="premium-actions">
      <%= link_to services_path, class: "premium-action-btn primary" do %>
        <span class="btn-icon">üåü</span>
        <span class="btn-text">Explore More Services</span>
      <% end %>

      <%= link_to dashboard_path, class: "premium-action-btn secondary" do %>
        <span class="btn-icon">üè†</span>
        <span class="btn-text">My Past Readings</span>
      <% end %>
    </div>

  </div>
</div>



<%# ============================================ %>
<%# JAVASCRIPT - CARRUSEL CENTRADO EN MOBILE %>
<%# ============================================ %>
<script defer>
document.addEventListener('DOMContentLoaded', function() {
  console.log('üé¥ Initializing Tarot Carousel...');

  const carousel = document.querySelector('.tarot-carousel');
  if (!carousel) return;

  const track = carousel.querySelector('.carousel-track');
  const cards = carousel.querySelectorAll('.carousel-card');
  const prevBtn = carousel.querySelector('.carousel-nav.prev');
  const nextBtn = carousel.querySelector('.carousel-nav.next');
  const indicators = carousel.querySelectorAll('.indicator');

  if (!track || cards.length === 0) {
    console.error('‚ùå Carousel elements not found');
    return;
  }

  console.log('‚úÖ Found:', cards.length, 'cards');

  let currentIndex = 0;

  function getCardWidth() {
    const card = cards[0];
    if (!card) return 312;

    // En mobile, calcular din√°micamente
    if (window.innerWidth <= 768) {
      const containerWidth = carousel.querySelector('.carousel-track-container').offsetWidth;
      const cardWidth = card.offsetWidth;
      const gap = 32; // 2rem
      return cardWidth + gap;
    }

    // En desktop, usar ancho fijo
    return 312; // 280px card + 32px gap
  }

  function centerCard(index) {
    const cardWidth = getCardWidth();
    const containerWidth = carousel.querySelector('.carousel-track-container').offsetWidth;
    const cardActualWidth = cards[0].offsetWidth;

    // Calcular offset para centrar la carta
    let offset;

    if (window.innerWidth <= 768) {
      // En mobile: centrar cada carta
      const centerOffset = (containerWidth - cardActualWidth) / 2;
      offset = -(index * cardWidth) + centerOffset;
    } else {
      // En desktop: comportamiento normal
      offset = -(index * cardWidth);
    }

    track.style.transform = `translateX(${offset}px)`;
    track.style.transition = 'transform 0.5s cubic-bezier(0.4, 0, 0.2, 1)';

    // Actualizar clases active
    cards.forEach(function(card, i) {
      if (i === index) {
        card.classList.add('active');
      } else {
        card.classList.remove('active');
      }
    });

    indicators.forEach(function(indicator, i) {
      if (i === index) {
        indicator.classList.add('active');
      } else {
        indicator.classList.remove('active');
      }
    });

    // Actualizar botones
    if (prevBtn) prevBtn.disabled = (index === 0);
    if (nextBtn) nextBtn.disabled = (index === cards.length - 1);

    currentIndex = index;
    console.log('Moved to card:', index);
  }

  // Event listeners
  if (prevBtn) {
    prevBtn.addEventListener('click', function() {
      if (currentIndex > 0) {
        centerCard(currentIndex - 1);
      }
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener('click', function() {
      if (currentIndex < cards.length - 1) {
        centerCard(currentIndex + 1);
      }
    });
  }

  indicators.forEach(function(indicator, index) {
    indicator.addEventListener('click', function() {
      centerCard(index);
    });
  });

  // Teclas de flecha
  document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft' && currentIndex > 0) {
      centerCard(currentIndex - 1);
    } else if (e.key === 'ArrowRight' && currentIndex < cards.length - 1) {
      centerCard(currentIndex + 1);
    }
  });

  // Swipe en mobile
  let touchStartX = 0;
  let touchEndX = 0;

  track.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
  }, { passive: true });

  track.addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  }, { passive: true });

  function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;

    if (Math.abs(diff) > swipeThreshold) {
      if (diff > 0 && currentIndex < cards.length - 1) {
        // Swipe left (siguiente)
        centerCard(currentIndex + 1);
      } else if (diff < 0 && currentIndex > 0) {
        // Swipe right (anterior)
        centerCard(currentIndex - 1);
      }
    }
  }

  // Recalcular en resize
  let resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
      centerCard(currentIndex);
    }, 250);
  });

  // Inicializar
  centerCard(0);
  console.log('‚úÖ Carousel initialized!');
});
</script>

<% content_for :body_class, 'has-stars-canvas' %>
